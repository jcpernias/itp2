---
title: "itp2"
format: 
  html:
    embed-resources: true
theme: flatly
editor: visual
---

## Preliminaries

We load the `tidyverse` packages in order to handle the databases:

```{r}
#| message: false

library(tidyverse)
```

Load the `sandwich` and `lmtest` packages that allow us to compute heteroskedasticity-robust standard errors and tests:

```{r}
#| message: false

library(sandwich)
library(lmtest)
```

Load the `modelsummary` package:

```{r}
#| message: false

library(modelsummary)
```

## Data

Read the database files:

```{r}
load("./data/households.RData")
load("./data/individuals.RData")
load("./data/pov_transition.RData")
```

Filter out data for 2005 edition of ECV an Â¡add some variables to the `pov_transition` database:

```{r}
pov <- local({
  tmp <- individuals |>
    select(id_p, birth_year, absent)
  pov_transition |> 
    filter(ecv_year != 2005) |> 
  left_join(tmp, by = "id_p") 
}) 
  
  
```

Create a variable for the different cohorts:

```{r}
pov <- pov |> 
  mutate(cohort = factor(case_when(birth_year %in% 1960:1965 ~ "60_65",
                                   birth_year %in% 1970:1975 ~ "70_75",
                                   birth_year %in% 1980:1985 ~ "80_85"),
                         levels = c("60_65", "70_75", "80_85")))
```

Filter out observations of people who do not belong to the chosen cohorts. Create a variable `povteen` that is `TRUE` for individuals who lived in poverty as teenagers.

```{r}
cohorts <- pov |>
  filter(!is.na(cohort)) |> 
  mutate(povteen = case_when(ecv_year == 2005 ~ 
                               fin_hardship %in% c("Very Often", "Often"),
                             ecv_year != 2005 ~
                               well_being %in% c("Very Bad", "Bad"))) |> 
  left_join(individuals, by = "id_p") |> 
  left_join(households, by = "id_hh") |> 
  mutate(income = ydisp_hh / cunits,
         teen_no_workers = nworking == 0)
```

Number of people in each cohort by year:

```{r}
cohorts |> 
  count(ecv_year, cohort) |> 
  pivot_wider(names_from = cohort, values_from = n)
```

Number of people who lived in poverty as teenagers by cohort and year:

```{r}
cohorts |> 
  filter(povteen == TRUE) |> 
  count(ecv_year, cohort) |> 
  pivot_wider(names_from = cohort, values_from = n)
```

## Regression models

### Baseline models

Linear probability model that explains `pov_hh`, the adult's household lives in poverty, using the explanatory `povteen`, poverty when he was a teenager, and `ecv_year`. $$
pov\_hh = \beta_0 + \beta_1\, povteen + \beta_2\, ecv\_year + \beta_3\, povteen \cdot ecv\_year + u
$$

Born in 1960-1965 cohort:

```{r}
mod0_60_65 <- lm(pov_hh ~ povteen * ecv_year, 
                 data = cohorts, 
                 subset = ecv_year != 2005 & cohort == "60_65")
```

Born in 1970-1975 cohort:

```{r}
mod0_70_75 <- lm(pov_hh ~ povteen * ecv_year, 
                 data = cohorts, 
                 subset = ecv_year != 2005 & cohort == "70_75")
```

Born in 1980-1985 cohort:

```{r}
mod0_80_85 <- lm(pov_hh ~ povteen * ecv_year, 
           data = cohorts, 
           subset = ecv_year != 2005 & cohort == "80_85")
```

Regression models summary table:

```{r}
models <- list("60_65" = mod0_60_65,
               "70_75" = mod0_70_75,
               "80_85" = mod0_80_85)

modelsummary(models, vcov = "HC3", 
             stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
             gof_map = c("nobs", "rmse", "r.squared", "vcov.type"))
```
