---
title: "itp2"
date: last-modified
toc: true
number-sections: true
number-depth: 3
format-links: false

format:
  html:
    theme: flatly
    embed-resources: true
editor: visual
---

## Preliminaries

We load the `tidyverse` packages in order to handle the databases:

```{r}
#| message: false

library(tidyverse)
```

Load the `sandwich` and `lmtest` packages that allow us to compute heteroskedasticity-robust standard errors and tests:

```{r}
#| message: false

library(sandwich)
library(lmtest)
```

Load the `modelsummary` package:

```{r}
#| message: false

library(modelsummary)
```

## Data

Read the database files:

```{r}
load("./data/households.RData")
load("./data/individuals.RData")
load("./data/pov_transition.RData")
```

Filter out data for 2005 edition of ECV and add some variables to the `pov_transition` database:

```{r}
pov <- local({
  tmp <- individuals |>
    select(id_p, birth_year, absent)
  pov_transition |> 
    filter(ecv_year != 2005) |> 
    left_join(tmp, by = "id_p") 
}) 
```

Create a variable for the different cohorts:

```{r}
pov <- pov |> 
  mutate(cohort = 
           factor(case_when(birth_year %in% 1960:1965 ~ "60_65",
                            birth_year %in% 1970:1975 ~ "70_75",
                            birth_year %in% 1980:1985 ~ "80_85"),
                  levels = c("60_65", "70_75", "80_85")))
```

Filter out observations of people who do not belong to the chosen cohorts. Create a variable `povteen` that is `TRUE` for individuals who lived in poverty as teenagers.

```{r}
cohorts <- pov |>
  filter(!is.na(cohort)) |> 
  mutate(povteen = well_being %in% c("Very Bad", "Bad")) |> 
  left_join(individuals, by = "id_p") |> 
  left_join(households, by = "id_hh") |> 
  mutate(income = ydisp_hh / cunits,
         teen_no_workers = nworking == 0,
         native = country_birth == "Spain",
         pnative = fcountry == "Spain" & mcountry == "Spain",
         female = sex == "Female",
         both_parents = !fabsent & !mabsent,
         no_jobs = nworking == 0,
         no_adults = adults == 0,
         peduc_med = feduc == "Med" | meduc == "Med",
         peduc_hi = feduc == "High" | meduc == "High",
         ) |> 
  select(pov_hh, povteen, ecv_year, cohort,
         no_jobs, pnative, native, female,
         fabsent, mabsent, both_parents, peduc_med, peduc_hi,
         educ_none, educ_prim, educ_sec, educ_sup) |> 
  drop_na()
```

### Descriptive statistics

Â Number of people in each cohort by year:

```{r}
tab <- cohorts |> 
  count(ecv_year, cohort) |> 
  pivot_wider(names_from = cohort, values_from = n)

all <- tab |> 
  select(-ecv_year) |> 
  summarise_all(sum) |> 
  mutate(ecv_year = "All", .before = everything())
bind_rows(tab, all)
```

All variables are binary. Percent of observations that satisfy the corresponding condition.

```{r}
cohorts |> 
  group_by(cohort) |> 
  summarise(pov_hh = 100 * mean(pov_hh), 
            povteen = 100 * mean(povteen),
            no_jobs = 100 * mean(no_jobs),
            native = 100 * mean(native),
            pnative = 100 * mean(pnative),
            female = 100 * mean(female),
            both_parents = 100 * mean(both_parents),
            peduc_med = 100 * mean(peduc_med),
            peduc_hi = 100 * mean(peduc_hi),
            ) |> 
  pivot_longer(cols = -cohort,
               names_to = "names") |> 
  pivot_wider(names_from = cohort, 
              values_from = value)
```

## Regression models

### Baseline models

Linear probability model that explains `pov_hh`, the adult's household lives in poverty, using the explanatory `povteen`, poverty when he was a teenager, and `ecv_year`. $$
pov\_hh = \beta_0 + \beta_1\, povteen + \beta_2\, ecv\_year + \beta_3\, povteen \cdot ecv\_year + u
$$

```{r}
frml <- pov_hh ~ povteen * ecv_year
mod0_60_65 <- lm(frml, data = cohorts, subset = cohort == "60_65")
mod0_70_75 <- lm(frml, data = cohorts, subset = cohort == "70_75")
mod0_80_85 <- lm(frml, data = cohorts, subset = cohort == "80_85")

models <- list("60_65" = mod0_60_65,
               "70_75" = mod0_70_75,
               "80_85" = mod0_80_85)

modelsummary(models, vcov = "HC3", 
             stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
             gof_map = c("nobs", "rmse", "r.squared", "vcov.type"))
```

### More regressors

```{r}
frml <- pov_hh ~ povteen * ecv_year + no_jobs + native + pnative + 
  female +  both_parents + peduc_med + peduc_hi


mod1_60_65 <- lm(frml,  data = cohorts, subset = cohort == "60_65")
mod1_70_75 <- lm(frml,  data = cohorts, subset = cohort == "70_75")
mod1_80_85 <- lm(frml,  data = cohorts, subset = cohort == "80_85")

models <- list("60_65" = mod1_60_65,
               "70_75" = mod1_70_75,
               "80_85" = mod1_80_85)

modelsummary(models, vcov = "HC3", 
             stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
             gof_map = c("nobs", "rmse", "r.squared", "vcov.type"))
```

### The role of education

```{r}
cohorts_ed <- cohorts |> 
  mutate(educ = factor(case_when(educ_none == TRUE ~ "None",
                                 educ_prim == TRUE ~ "Prim",
                                 educ_sec == TRUE ~ "Sec",
                                 educ_sup == TRUE ~ "Sup"),
                       levels = c("None", "Prim", "Sec", "Sup")))

cohorts_ed |> group_by(cohort, educ) |> 
  summarise(fpov = mean(pov_hh) * 100, .groups = "drop") |> 
  pivot_wider(names_from = cohort, values_from = fpov)
```

```{r}
tab <- cohorts_ed |> filter(povteen == TRUE) |> 
  group_by(cohort, educ) |> 
  summarise(fed = n(), .groups = "drop") |> 
  pivot_wider(names_from = cohort, values_from = fed)

marg <- tab |> select(-educ) |> summarise_all(sum)

tab_povteen <- tab |> 
  mutate(`60_65` = `60_65` / marg[["60_65"]] * 100, 
         `70_75` = `70_75` / marg[["70_75"]] * 100, 
         `80_85` = `80_85` / marg[["80_85"]] * 100)
tab_povteen
```

```{r}
tab <- cohorts_ed |> filter(povteen == FALSE) |> 
  group_by(cohort, educ) |> 
  summarise(fed = n(), .groups = "drop") |> 
  pivot_wider(names_from = cohort, values_from = fed)

marg <- tab |> select(-educ) |> summarise_all(sum)

tab_nopovteen <- tab |> 
  mutate(`60_65` = `60_65` / marg[["60_65"]] * 100, 
         `70_75` = `70_75` / marg[["70_75"]] * 100, 
         `80_85` = `80_85` / marg[["80_85"]] * 100)
tab_nopovteen
```

```{r}
library(ggplot2)

t1 <- tab_povteen |> 
  pivot_longer(cols = -educ) |> 
  mutate(povteen = TRUE)

t2 <- tab_nopovteen |> 
  pivot_longer(cols = -educ) |> 
  mutate(povteen = FALSE)

db <- bind_rows(t1, t2)
```

```{r}
ggplot(data = filter(db, name == "60_65"),
       aes(x = educ, y = value, fill = povteen)) +
  geom_bar(position = "dodge", stat = "identity")
```

```{r}
ggplot(data = filter(db, name == "70_75"),
       aes(x = educ, y = value, fill = povteen)) +
  geom_bar(position = "dodge", stat = "identity")
```

```{r}
ggplot(data = filter(db, name == "80_85"),
       aes(x = educ, y = value, fill = povteen)) +
  geom_bar(position = "dodge", stat = "identity")
```
