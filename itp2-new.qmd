---
title: itp2-new
---

## Preliminaries

Load the `tidyverse` and `glue` packages:

```{r}
#| message: false

library(tidyverse)
library(glue)
```

Load the `sandwich` and `lmtest` packages that allow us to compute heteroskedasticity-robust standard errors and tests:

```{r}
#| message: false

library(sandwich)
library(lmtest)
```

Load the `modelsummary` package:

```{r}
#| message: false

library(modelsummary)
```

## Data

Read the database files:

```{r}
load("./data/households.RData")
load("./data/individuals.RData")
load("./data/pov_transition.RData")
```

Filter out data for 2005 edition of ECV and add some variables to the `pov_transition` database:

```{r}
pov <- local({
  tmp <- individuals |>
    select(id_p, birth_year, absent)
  pov_transition |> 
    filter(ecv_year != 2005) |> 
  left_join(tmp, by = "id_p") 
}) 
```

Define cohort indicators.

```{r}
# Number of years in each cohort
span_cohort <- 5

# Start year of first cohort
start_year <- 1960

# Number of cohorts
num_cohorts <- 5

# Build cohort labels
start_cohort <- seq(from = start_year, by = span_cohort, length.out = num_cohorts)
end_cohort <- start_cohort + span_cohort - 1
cohort_labels <- glue("{start_cohort}-{end_cohort}")

# Add cohort indicator to the dataset
pov <- pov |> 
  mutate(cohort = cut(birth_year, 
                      seq(from = start_year, by = span_cohort, 
                          length.out = num_cohorts + 1), 
                      right = FALSE, labels = cohort_labels))
```

Create a table showing the age range for each cohort during the years the survey was conducted.

```{r}
ecv_years <- c(2010, 2018)
cohort_tab_lst <- 
  map(ecv_years, \(x) glue("{x - end_cohort}-{x - start_cohort}")) |> 
    set_names(glue("Age range at {ecv_years}"))
cohort_tab <-
  append(list("Cohorts" = cohort_labels), cohort_tab_lst) |> 
    as_tibble()
str_join <- \(x) paste0(x, collapse = "")
align_str <- str_join(c("l", rep("r", NCOL(cohort_tab) - 1)))
datasummary_df(cohort_tab, fmt = 0, align = align_str)
```

Filter out observations of people who do not belong to the chosen cohorts. Create a variable `povteen` that is `TRUE` for individuals who lived in poverty as teenagers.

```{r}
cohorts <- pov |>
  filter(!is.na(cohort)) |> 
  mutate(povteen = well_being %in% c("Very Bad", "Bad")) |> 
  left_join(select(individuals, 
                   -c(ecv_year, age, birth_year, absent)), 
                   by = "id_p") |> 
  left_join(select(households,
                   -c(ecv_year)), by = "id_hh") |> 
  mutate(income = ydisp_hh / cunits,
         teen_no_workers = nworking == 0)
```

Number of people in each cohort by year:

```{r}
nobs_tab <- cohorts |> 
  count(ecv_year, cohort) |> 
  pivot_wider(names_from = ecv_year, values_from = n)
str_join <- \(x) paste0(x, collapse = "")
align_str <- str_join(c("l", rep("r", NCOL(nobs_tab) - 1)))
datasummary_df(nobs_tab, fmt = 0, align = align_str)
```

Number of people who lived in poverty as teenagers by cohort and year:

```{r}
nteen_tab <- cohorts |> 
  filter(povteen == TRUE) |> 
  count(ecv_year, cohort) |> 
  pivot_wider(names_from = ecv_year, values_from = n)
nteen_tab
```

Fraction of people who lived in poverty as teenagers in each cohort by year:

```{r}
left_join(nobs_tab, nteen_tab, by = "cohort") |> 
  mutate(`2011` = `2011.y` / `2011.x` * 100,
         `2019` = `2019.y` / `2019.x` * 100) |> 
  select(-contains("."))
```

Number of people who lived in poverty as adults by cohort and year:

```{r}
nadult_tab <- cohorts |> 
  filter(pov_hh == TRUE) |> 
  count(ecv_year, cohort) |> 
  pivot_wider(names_from = ecv_year, values_from = n)
nadult_tab
```

Fraction of people who lived in poverty as teenagers in each cohort by year:

```{r}
left_join(nobs_tab, nadult_tab, by = "cohort") |> 
  mutate(`2011` = `2011.y` / `2011.x` * 100,
         `2019` = `2019.y` / `2019.x` * 100) |> 
  select(-contains("."))
```

Transition matrix of teen and adult poverty by cohort and year:

```{r}
trans_pov <- cohorts |> 
  count(ecv_year, cohort, povteen, pov_hh) |> 
  mutate(povtrans = case_when(!povteen & !pov_hh ~ "FF",
                              !povteen & pov_hh ~ "FT",
                              povteen & !pov_hh ~ "TF",
                              povteen & pov_hh ~ "TT")) |> 
  select(-c(povteen, pov_hh)) |> 
  pivot_wider(names_from = povtrans, values_from = n)
trans_pov
```

Transition matrix by year and cohort (percentages):

```{r}
trans_pov |> 
  mutate(total = FF + FT + TF + TT,
         FF_pct = FF / total * 100, 
         FT_pct = FT / total * 100, 
         TF_pct = TF / total * 100, 
         TT_pct = TT / total * 100) |> 
  select(-c(FF, FT, TF, TT, total))
```

Probability of adult poverty conditional on experiencing youth poverty:

```{r}
trans_pov |> 
  mutate(No = FT / (FT + FF),
         Yes = TT / (TF + TT), 
         ratio = Yes / No) |> 
  select(ecv_year, cohort, No, Yes, ratio)
```

## Regressions

Basic linear probability model:

$$
pov\_hh = \beta_0 + \beta_1 povteen + \beta_2 ecv\_year2019 + 
\beta_3 povteen \cdot ecv\_year2019 + u
$$

Whole sample:

```{r}
base_frml <- pov_hh ~ povteen * ecv_year
mod_base_all <- lm(base_frml, data = cohorts)
modelsummary(mod_base_all, vcov = "HC3", 
             stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
             gof_map = c("nobs", "rmse", "r.squared", "vcov.type"))
```
