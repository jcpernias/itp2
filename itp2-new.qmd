---
title: itp2-new
---

## Preliminaries

Load the `tidyverse` and `glue` packages:

```{r}
#| message: false

library(tidyverse)
library(glue)
```

Load the `sandwich` and `lmtest` packages that allow us to compute heteroskedasticity-robust standard errors and tests:

```{r}
#| message: false

library(sandwich)
library(lmtest)
```

Load the `modelsummary` package:

```{r}
#| message: false

library(modelsummary)
```

## Data

Read the database files:

```{r}
load("./data/households.RData")
load("./data/individuals.RData")
load("./data/pov_transition.RData")
```

Define which years of the ECV are used:

```{r}
ecv_years <- c(2011, 2019)
```

Filter out data from editions of ECV not in `ecv_years`, remove the variables that only appear in the 2005 edition, and add some variables to the `pov_transition` database:

```{r}
pov <- local({
  tmp <- individuals |>
    select(id_p, birth_year, absent)
  pov_transition |> 
    filter(ecv_year %in% ecv_years) |> 
  left_join(tmp, by = "id_p") |> 
    select(!c(siblings, fin_hardship))
}) 
```

Define cohort indicators.

```{r}
# Number of years in each cohort
span_cohort <- 5

# Start year of first cohort
start_year <- 1960

# Number of cohorts
num_cohorts <- 5

# Build cohort labels
start_cohort <- 
  seq(from = start_year, by = span_cohort, length.out = num_cohorts)
end_cohort <- start_cohort + span_cohort - 1
cohort_labels <- glue("{start_cohort}-{end_cohort}")

# Add cohort indicator to the dataset
pov <- pov |> 
  mutate(cohort = 
           cut(birth_year, 
               seq(from = start_year, by = span_cohort, 
                   length.out = num_cohorts + 1), 
               right = FALSE, labels = cohort_labels))
```

Create a table showing the age range for each cohort during the years the survey was conducted.

```{r}
cohort_tab_lst <- 
  map(ecv_years, \(x) glue("{x - end_cohort}-{x - start_cohort}")) |> 
    set_names(glue("Age range at {ecv_years - 1}"))
cohort_tab <-
  append(list("Cohorts" = cohort_labels), cohort_tab_lst) |> 
    as_tibble()
str_join <- \(x) paste0(x, collapse = "")
align_str <- str_join(c("l", rep("r", NCOL(cohort_tab) - 1)))
datasummary_df(cohort_tab, fmt = 0, align = align_str)
```

Filter out observations of people who do not belong to the chosen cohorts and do not report household well-being during their adolescence. Also filter out observations where `institution` is not available. Create a variable `povteen` that is `TRUE` for individuals who lived in poverty as teenagers.

```{r}
cohorts <- pov |>
  filter(!is.na(cohort), !is.na(well_being), !is.na(institution)) |> 
  mutate(povteen = well_being %in% c("Very Bad", "Bad")) |> 
  left_join(select(individuals, 
                   -c(ecv_year, age, birth_year, absent)), 
                   by = "id_p") |> 
  left_join(select(households, !ecv_year), by = "id_hh") |> 
  mutate(income = ydisp_hh / cunits,
         teen_no_workers = nworking == 0)
```

Number of people in each cohort by year:

```{r}
pov_counts <- local({
  nobs_tab <- cohorts |> 
    count(ecv_year, cohort, name = "nobs")

  nteen_tab <- cohorts |> 
    filter(povteen == TRUE) |> 
    count(ecv_year, cohort, name = "nteen")

  nadult_tab <- cohorts |> 
    filter(pov_hh == TRUE) |> 
    count(ecv_year, cohort, name = "nadult")
  
  nobs_tab |> 
    left_join(nteen_tab, by = join_by(ecv_year, cohort)) |> 
    left_join(nadult_tab, by = join_by(ecv_year, cohort)) 
})

datasummary_df(pov_counts, fmt = 0, align = "ccrrr")
```

Proportion of observations by year and cohort:

```{r}
pov_freq <- pov_counts |> 
  mutate(teen_pct = nteen / nobs * 100, 
         adult_pct = nadult / nobs * 100) |> 
  select(-c(nobs, nteen, nadult)) 

datasummary_df(pov_freq, fmt = 1, align = "ccrr")
```

Transition matrix of teen and adult poverty by cohort and year:

```{r}
blbls = c("F", "T")
trans_pov <- cohorts |> 
  count(ecv_year, cohort, povteen, pov_hh) |> 
  mutate(povtrans = 
           glue("{blbls[povteen + 1]}{blbls[pov_hh + 1]}")) |> 
  select(-c(povteen, pov_hh)) |> 
  pivot_wider(names_from = povtrans, values_from = n)  
datasummary_df(trans_pov, fmt = 0, align = "llrrrr")
```

Transition matrix by year and cohort (percentages):

```{r}
trans_pov |> 
  mutate(total = FF + FT + TF + TT,
         FF_pct = FF / total * 100, 
         FT_pct = FT / total * 100, 
         TF_pct = TF / total * 100, 
         TT_pct = TT / total * 100) |> 
  select(-c(FF, FT, TF, TT, total)) |> 
  datasummary_df(fmt = 1, align = "llrrrr")
```

Probability of adult poverty conditional on experiencing youth poverty:

```{r}
trans_pov |> 
  mutate(No = FT / (FT + FF),
         Yes = TT / (TF + TT), 
         ratio = Yes / No) |> 
  select(ecv_year, cohort, No, Yes, ratio) |> 
  datasummary_df(fmt = 2, align = "llccc")
```

## Regressions

Basic linear probability model:

$$
pov\_hh = \beta_0 + \beta_1 povteen + \beta_2 ecv\_year2019 + 
\beta_3 povteen \cdot ecv\_year2019 + u
$$

Whole sample:

```{r}
base_frml <- pov_hh ~ povteen * ecv_year
mod_base_all <- lm(base_frml, data = cohorts)
modelsummary(mod_base_all, vcov = "HC3", 
             stars = c("*" = 0.1, "**" = 0.05, "***" = 0.01),
             gof_map = c("nobs", "rmse", "r.squared", "vcov.type"))
```
